---
title: "assignment04"
output: pdf_document
author: "author: Jordan Grover, jg2058"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


```

## Instructions

Your analysis should have four data visualizations of distinct graph types, made with ggplot2. Across all
four graphs, use a total of:
• Six different aesthetics (i.e. set inside aes());
• Six different non-aesthetic options (i.e. set outside aes());
• Five different geoms;
• Two different scales (meaning change the default scale used for at least two aesthetics).
Further, each graph must include:
• Correct usage of all visual encodings;
• Appropriate data sourcing (hint, check out the labs() function);
• Proper labeling of all visual encodings;
• An appropriate title and subtitle;

## Data Source

Pandemic Oversight Coronavirus Relief Fund details
https://www.pandemicoversight.gov/data-interactive-tools/interactive-dashboards/data-exports

#Visualization 1

Description of Viz 1: The goal of this visualization is to first help us understand who is actually receiving awards. With that understanding, we can layer on top, how many awards they receive, how much, and for what purposes. 

```{r cars}
library(tidyverse)
library(ggplot2)
library(urbnthemes)
data <- read.csv("CRF_details.csv")

#List of Prime Recipients
unique(data$Prime.recipient)

#summarize by how many recipients in each recipient type
#two geoms
#one scale
#one aes option (fill)
#one non aes option(position nudge)

data %>%
   mutate(Type = if_else(str_detect(Prime.recipient,"STATE|COMMONWEALTH"),"State", if_else(str_detect(Prime.recipient,"COUNTY"),"County",if_else(str_detect(Prime.recipient,"TRIBE|NATION|TRIBAL|NATIVE|INDIAN|COUNCIL"), "Tribe",if_else(str_detect(Prime.recipient,"CITY|MUNICIPALITY|VILLAGE|TOWN|PUBELO"), "City, Town, or Village","Other")))))%>%
  group_by(Type)%>%
  summarize(award_count = length(unique(Prime.recipient)))%>%
  ggplot()+
  geom_col(mapping = aes(x=Type, y = award_count, fill = Type))+
  scale_fill_brewer(palette="palette_urbn")+
    labs(y = "Number of Recipients")+
  labs(title = "The vast majority of award recipients are tribal nations",subtitle = "Number of recipients by recipient type",caption = "Source: Pandemicoversight.gov")+
  geom_text(mapping = aes(x = Type, y = award_count, label = award_count),position = position_nudge(y = +20))

```

## Visualization 2

Now knowing the breakdown of recipient types, how many grants are they receiving, and for how much? Each award is broken down into a sub recipient, an award, and then a spending category. I would like to just count how many unique awards there are per prime recipient, and what the sum of their awards are. To do that, I will make a new data set with Prime Recipient, Distinct Award, and Award Amount. There is no distinct ID for prime award, so I have made one by combining Prime Recipient with Award Amount, and looking for the distinct combinations of the two (there is usually a 1-1 relationship between the two, but not always)

For smaller recipient types (counties, tribes, and municipalities), about how much have they been awarded?


```{r 2}
library(tidyverse)
library(ggplot2)
library(urbnthemes)
library("stringr")


data%>%
  mutate(recipient_amount = paste(Prime.recipient,Award.amount,Sep = " ", callapse = NULL))%>%
  distinct(across(recipient_amount),.keep_all = TRUE)%>%
  summarize(recipients = length(unique(Prime.recipient)))

Distinct_Award_Data <- data%>%
  mutate(Award_number_new = ifelse(Award.number=="",0,Award.number))%>%
  mutate(Award = paste(Prime.recipient, Award_number_new, sep = " - ", collapse = NULL)) %>%
  mutate(Award_amount_detail = ifelse(is.na(Sub.award.amount),Award.amount,Sub.award.amount))%>%
   mutate(Type = if_else(str_detect(Prime.recipient,"STATE|COMMONWEALTH"),"State", if_else(str_detect(Prime.recipient,"COUNTY"),"County",if_else(str_detect(Prime.recipient,"TRIBE|NATION|TRIBAL|NATIVE|INDIAN|COUNCIL"), "Tribe",if_else(str_detect(Prime.recipient,"CITY|MUNICIPALITY|VILLAGE|TOWN|PUBELO"), "City, Town, or Village","Other")))))%>%
   mutate(recipient_amount = paste(Prime.recipient,Award.amount,Sep = " ", callapse = NULL))%>%
  distinct(across(recipient_amount),.keep_all = TRUE)%>%
  select(Prime.recipient, recipient_amount, Award.amount, Type)%>%
    distinct(across(recipient_amount),.keep_all = TRUE) 


#one new geom
#one new scale
#one new non aes option (label number)
#one new aes option (label)

library(scales)
Distinct_Award_Data%>%
  filter(Type != "State", Type !="Other")%>%
  ggplot()+
  geom_boxplot(mapping = aes(x = Type, y = Award.amount, na.rm = FALSE))+
  scale_y_continuous(labels = label_number( scale = 1e-9))+
  labs(title = "Obvious Outliers in Pandemic Relief Award Recipients", subtitle = "Distribution of pandemic spending amongst localities", caption = "Source: Pandemicoversight.gov")+
labs(y = "Award Amount In Billions", x = "Recipient Type")+
  annotate(geom = "text", x = 1.1, y = 1490000000, 
    label = "New York City", hjust = 0, vjust = 1, size = 4)+
    annotate(geom = "text", x = 2.1, y = 1090000000, 
    label = "LA County", hjust = 0, vjust = 1, size = 4)+
  annotate(geom = "text", x = 3.1, y = 750000000, 
    label = "Navajo Nation", hjust = 0, vjust = 1, size = 4)
```


#Visualization Three

Now for the larger grants, let's try to get a better sense at where that money is going, and how much has been spent. For our state recipients, lets narrow in on the sub-recipients. 

```{r 3}
library(tidyverse)
library(ggplot2)
library(urbnthemes)
data %>%
  mutate(Type = if_else(str_detect(Prime.recipient,"STATE|COMMONWEALTH"),"State", if_else(str_detect(Prime.recipient,"COUNTY"),"County",if_else(str_detect(Prime.recipient,"TRIBE|NATION|TRIBAL|NATIVE|INDIAN|COUNCIL"), "Tribe",if_else(str_detect(Prime.recipient,"CITY|MUNICIPALITY|VILLAGE|TOWN|PUBELO"), "City, Town, or Village","Other")))))%>%
  select(Money.spent.to.date, Spending.category, Type)%>%
  group_by(Spending.category)%>%
    summarize(total = sum(Money.spent.to.date))%>%
  mutate(Category = fct_reorder(Spending.category, total))%>%
  ggplot()+
  geom_col(mapping = aes(x = Category, y = total, fill = total))+
    labs(y = "Total Amount Spent (Billions)")+
  labs(title = "Payroll ranks second to highest for spending category, next to miscelaneous",subtitle = "Pandemic Relief Reported Spending",caption = "Source: Pandemicoversight.gov")+
   scale_y_continuous(labels = label_number( scale = 1e-9))+
  theme_minimal()+
  scale_x_discrete(label=function(x) stringr::str_trunc(x, 20))+
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```
